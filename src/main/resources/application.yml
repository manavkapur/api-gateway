server:
  port: ${PORT:8080}
  error:
    include-message: always
    include-binding-errors: always

spring:
  application:
    name: api-gateway

  main:
    web-application-type: reactive
    allow-bean-definition-overriding: true

  codec:
    max-in-memory-size: 5MB

  data:
    redis:
      host: ${SPRING_REDIS_HOST:localhost}
      port: ${SPRING_REDIS_PORT:6379}
      password: ${SPRING_REDIS_PASSWORD:}
      ssl:
        enabled: ${SPRING_REDIS_SSL_ENABLED:false}

  cloud:
    loadbalancer:
      ribbon:
        enabled: false

    gateway:
      preserve-host-header: true
      forwarded-headers-strategy: FRAMEWORK

      httpclient:
        connect-timeout: 5000
        response-timeout: 10s

      discovery:
        locator:
          enabled: false
          lower-case-service-id: true

      # ✅ Full Global CORS – iOS + Web + Postman
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOriginPatterns:
              - "http://localhost:3000"
              - "https://supremebuildsolutions.vercel.app"
              - "https://supremebuildsolutions.com"
              - "https://www.supremebuildsolutions.com"
            allowedMethods: "*"
            allowedHeaders: "*"
            allowCredentials: true

      # ✅ Prevent duplicate headers
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_FIRST

      # ✅ ROUTES
      routes:
        - id: user-service
          uri: https://user-service-142422750329.asia-southeast1.run.app
          predicates:
            - Path=/user-service/api/**
          filters:
            - RewritePath=/user-service/(?<remaining>.*), /${remaining}
            - name: CircuitBreaker
              args:
                name: userCircuitBreaker
                fallbackUri: forward:/fallback/global

        - id: contact-service
          uri: https://contact-service-142422750329.asia-southeast1.run.app
          predicates:
            - Path=/contact-service/**
          filters:
            - RewritePath=/contact-service/(?<path>.*), /${path}
            - name: CircuitBreaker
              args:
                name: contactCircuitBreaker
                fallbackUri: forward:/fallback/global

        # ✅ FIXED: correct rewrite for /api/quotes paths
        - id: quote-service
          uri: https://quote-service-142422750329.asia-southeast1.run.app
          predicates:
            - Path=/quote-service/api/**
          filters:
            - RewritePath=/quote-service/(?<remaining>.*), /${remaining}
            - name: CircuitBreaker
              args:
                name: quoteCircuitBreaker
                fallbackUri: forward:/fallback/global

        - id: notification-service
          uri: https://notification-service-142422750329.asia-southeast1.run.app
          predicates:
            - Path=/notification-service/**
          filters:
            - RewritePath=/notification-service/(?<path>.*), /${path}
            - name: CircuitBreaker
              args:
                name: notificationCircuitBreaker
                fallbackUri: forward:/fallback/global

        - id: email-service
          uri: https://email-service-142422750329.asia-southeast1.run.app
          predicates:
            - Path=/email-service/**
          filters:
            - RewritePath=/email-service/(?<path>.*), /${path}
            - name: CircuitBreaker
              args:
                name: emailCircuitBreaker
                fallbackUri: forward:/fallback/global

        - id: channel-server
          uri: https://channel-server-142422750329.asia-southeast1.run.app
          predicates:
            - Path=/channel-server/api/**
          filters:
            - RewritePath=/channel-server/(?<remaining>.*), /${remaining}
            - name: CircuitBreaker
              args:
                name: channelCircuitBreaker
                fallbackUri: forward:/fallback/global

        - id: channel-ws
          uri: https://channel-server-142422750329.asia-southeast1.run.app
          predicates:
            - Path=/ws/**
          filters:
            - RewritePath=/ws/(?<remaining>.*), /ws/${remaining}

resilience4j:
  circuitbreaker:
    instances:
      globalCircuitBreaker:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
        automaticTransitionFromOpenToHalfOpenEnabled: true

eureka:
  client:
    fetch-registry: true
    register-with-eureka: true
    service-url:
      defaultZone: ${EUREKA_URL:https://eureka-server-142422750329.asia-southeast1.run.app/eureka/}
    registry-fetch-interval-seconds: 10
    lease-renewal-interval-in-seconds: 10
    lease-expiration-duration-in-seconds: 30
    eureka-server-connect-timeout-seconds: 5
    eureka-server-read-timeout-seconds: 8
    initial-instance-info-replication-interval-seconds: 5
    serviceUrlPollIntervalSeconds: 60

  instance:
    prefer-ip-address: false
    hostname: ${CLOUD_RUN_HOST:api-gateway-142422750329.asia-southeast1.run.app}
    instance-id: ${spring.application.name}:${random.value}
    non-secure-port-enabled: false
    secure-port-enabled: true
    status-page-url: https://${CLOUD_RUN_HOST:api-gateway-142422750329.asia-southeast1.run.app}/actuator/health
    health-check-url: https://${CLOUD_RUN_HOST:api-gateway-142422750329.asia-southeast1.run.app}/actuator/health
    metadata-map:
      management.port: ${server.port}

management:
  endpoints:
    web:
      exposure:
        include: health, info, prometheus, metrics, env
  endpoint:
    health:
      show-details: always
  health:
    redis:
      enabled: false
    discovery:
      enabled: false
    circuitbreakers:
      enabled: false
    refresh:
      enabled: false

logging:
  level:
    org.springframework.cloud.gateway: INFO
    org.springframework.web.reactive.function.client.ExchangeFunctions: DEBUG
    root: INFO