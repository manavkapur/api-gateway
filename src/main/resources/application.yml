server:
  port: ${PORT:8080} # ✅ Cloud Run sets PORT automatically
  error:
    include-message: always
    include-binding-errors: always

spring:
  application:
    name: api-gateway

  main:
    web-application-type: reactive  # ✅ Force reactive Netty mode for Cloud Run

  codec:
    max-in-memory-size: 5MB   # ✅ Fix for POST JSON body buffering (prevents 500 errors)

  data:
    redis:
      host: ${SPRING_REDIS_HOST:localhost}
      port: ${SPRING_REDIS_PORT:6379}
      password: ${SPRING_REDIS_PASSWORD:}
      ssl:
        enabled: ${SPRING_REDIS_SSL_ENABLED:false}

  cloud:
    loadbalancer:
      ribbon:
        enabled: false

    gateway:
      httpclient:
        connect-timeout: 5000
        response-timeout: 10s
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true

      # ✅ Global CORS configuration
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOriginPatterns:
              - "http://localhost:3000"
              - "https://supremebuildsolutions.vercel.app"
              - "https://supremebuildsolutions.com"
              - "https://www.supremebuildsolutions.com"
            allowedMethods: "*"
            allowedHeaders: "*"
            allowCredentials: true

      # ✅ Deduplicate headers to prevent duplicate CORS entries
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_FIRST

      # ✅ Direct HTTPS routes to Cloud Run microservices (prevents SSL/TLS mismatch)
      routes:
        - id: user-service
          uri: https://user-service-142422750329.asia-southeast1.run.app
          predicates:
            - Path=/user-service/**
          filters:
            - StripPrefix=1
            - name: CircuitBreaker
              args:
                name: userCircuitBreaker
                fallbackUri: forward:/fallback/global

        - id: contact-service
          uri: https://contact-service-142422750329.asia-southeast1.run.app
          predicates:
            - Path=/contact-service/**
          filters:
            - StripPrefix=1
            - name: CircuitBreaker
              args:
                name: contactCircuitBreaker
                fallbackUri: forward:/fallback/global

        - id: quote-service
          uri: https://quote-service-142422750329.asia-southeast1.run.app
          predicates:
            - Path=/quote-service/**
          filters:
            - StripPrefix=1
            - name: CircuitBreaker
              args:
                name: quoteCircuitBreaker
                fallbackUri: forward:/fallback/global

        - id: notification-service
          uri: https://notification-service-142422750329.asia-southeast1.run.app
          predicates:
            - Path=/notification-service/**
          filters:
            - StripPrefix=1
            - name: CircuitBreaker
              args:
                name: notificationCircuitBreaker
                fallbackUri: forward:/fallback/global

        - id: email-service
          uri: https://email-service-142422750329.asia-southeast1.run.app
          predicates:
            - Path=/email-service/**
          filters:
            - StripPrefix=1
            - name: CircuitBreaker
              args:
                name: emailCircuitBreaker
                fallbackUri: forward:/fallback/global

        - id: channel-server
          uri: https://channel-server-142422750329.asia-southeast1.run.app
          predicates:
            - Path=/channel-server/**
          filters:
            - StripPrefix=1
            - name: CircuitBreaker
              args:
                name: channelCircuitBreaker
                fallbackUri: forward:/fallback/global

resilience4j:
  circuitbreaker:
    instances:
      globalCircuitBreaker:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
        automaticTransitionFromOpenToHalfOpenEnabled: true

# ---------- EUREKA ----------
eureka:
  client:
    fetch-registry: true
    register-with-eureka: true
    service-url:
      defaultZone: ${EUREKA_URL:https://eureka-server-142422750329.asia-southeast1.run.app/eureka/}

    # ✅ Make Eureka refresh and renew heartbeats frequently
    registry-fetch-interval-seconds: 10
    lease-renewal-interval-in-seconds: 10
    lease-expiration-duration-in-seconds: 30
    eureka-server-connect-timeout-seconds: 5
    eureka-server-read-timeout-seconds: 8
    initial-instance-info-replication-interval-seconds: 5
    serviceUrlPollIntervalSeconds: 60

  instance:
    prefer-ip-address: false
    hostname: ${CLOUD_RUN_HOST:api-gateway-142422750329.asia-southeast1.run.app}
    instance-id: ${spring.application.name}:${random.value}
    non-secure-port-enabled: false
    secure-port-enabled: true
    status-page-url: https://${CLOUD_RUN_HOST:api-gateway-142422750329.asia-southeast1.run.app}/actuator/health
    health-check-url: https://${CLOUD_RUN_HOST:api-gateway-142422750329.asia-southeast1.run.app}/actuator/health
    metadata-map:
      management.port: ${server.port}

# ---------- MANAGEMENT / ACTUATOR ----------
management:
  endpoints:
    web:
      exposure:
        include: health, info, prometheus, metrics, env
  endpoint:
    health:
      show-details: always

  health:
    redis:
      enabled: false
    discovery:
      enabled: false
    circuitbreakers:
      enabled: false
    refresh:
      enabled: false

logging:
  level:
    org.springframework.cloud.gateway: INFO
    org.springframework.web.reactive.function.client.ExchangeFunctions: DEBUG
    root: INFO
